name: ReconMaster Advanced Security Scan

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Target domain (requires authorization)"
        required: true
        type: string
      scan_mode:
        description: "Scan intensity level"
        required: false
        default: "passive"
        type: choice
        options:
          - passive
          - standard
          - comprehensive
      notify:
        description: "Send notifications"
        required: false
        default: true
        type: boolean
  schedule:
    - cron: "0 3 * * *"   # Daily at 03:00 UTC

env:
  PYTHON_VERSION: "3.11"
  GO_VERSION: "1.21"
  SCAN_TIMEOUT: 180
  MAX_RETRIES: 3

jobs:
  # Security and authorization check
  authorization-check:
    name: Authorization Verification
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
    steps:
      - name: Verify Authorization
        id: check
        run: |
          echo "âš ï¸  LEGAL NOTICE âš ï¸"
          echo "This scan must only be performed on domains you own or have written permission to test."
          echo "Unauthorized scanning may violate computer fraud laws."
          echo ""
          
          # Check if running on schedule or manual trigger
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # For scheduled runs, check if domains are configured
            if [ -z "${{ secrets.AUTHORIZED_DOMAINS }}" ]; then
              echo "âŒ ERROR: No authorized domains configured for scheduled scans"
              echo "Please configure AUTHORIZED_DOMAINS secret"
              exit 1
            fi
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            # For manual runs, require explicit confirmation
            if [ -z "${{ github.event.inputs.domain }}" ]; then
              echo "âŒ ERROR: No domain specified"
              exit 1
            fi
            echo "âœ… Manual scan authorized for: ${{ github.event.inputs.domain }}"
            echo "authorized=true" >> $GITHUB_OUTPUT
          fi

  # Prepare scan configuration
  prepare:
    name: Prepare Scan Matrix
    needs: authorization-check
    runs-on: ubuntu-latest
    outputs:
      domains: ${{ steps.set-domains.outputs.domains }}
      matrix: ${{ steps.set-domains.outputs.matrix }}
      scan_id: ${{ steps.set-domains.outputs.scan_id }}
    steps:
      - name: Generate Scan ID
        id: generate-id
        run: |
          SCAN_ID="scan-$(date +%Y%m%d-%H%M%S)-${{ github.run_number }}"
          echo "scan_id=$SCAN_ID" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Scan ID: $SCAN_ID"

      - name: Configure Domain Matrix
        id: set-domains
        run: |
          # Determine domains to scan
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DOMAINS="${{ github.event.inputs.domain }}"
          else
            DOMAINS="${{ secrets.AUTHORIZED_DOMAINS }}"
          fi
          
          if [ -z "$DOMAINS" ]; then
            echo "âŒ ERROR: No domains configured"
            exit 1
          fi
          
          # Validate domain format
          for domain in $(echo "$DOMAINS" | tr ',' ' '); do
            if ! echo "$domain" | grep -qE '^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'; then
              echo "âŒ ERROR: Invalid domain format: $domain"
              exit 1
            fi
          done
          
          # Convert to JSON array
          MATRIX=$(echo "$DOMAINS" | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "domains=$DOMAINS" >> $GITHUB_OUTPUT
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "scan_id=${{ steps.generate-id.outputs.scan_id }}" >> $GITHUB_OUTPUT
          
          echo "âœ… Configured domains: $DOMAINS"

  # Main reconnaissance job
  recon:
    name: Scan ${{ matrix.domain }}
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 180
    strategy:
      fail-fast: false
      max-parallel: 2  # Limit concurrent scans
      matrix:
        domain: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Cache Go Binaries
        uses: actions/cache@v4
        with:
          path: ~/go/bin
          key: go-tools-${{ runner.os }}-${{ hashFiles('.github/workflows/reconmaster.yml') }}
          restore-keys: |
            go-tools-${{ runner.os }}-

      - name: Install System Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            nmap \
            jq \
            chromium-browser \
            git \
            wget \
            ca-certificates \
            libpcap-dev
          
          echo "âœ… System dependencies installed"

      - name: Install Recon Tools
        run: |
          set -e
          
          echo "ðŸ“¦ Installing reconnaissance tools..."
          
          # Function to install Go tool with retry
          install_go_tool() {
            local tool=$1
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Installing $tool (attempt $attempt/$max_attempts)..."
              if go install -v "$tool@latest"; then
                echo "âœ… $tool installed successfully"
                return 0
              fi
              attempt=$((attempt + 1))
              sleep 2
            done
            
            echo "âŒ Failed to install $tool after $max_attempts attempts"
            return 1
          }
          
          # Install essential tools
          install_go_tool "github.com/projectdiscovery/subfinder/v2/cmd/subfinder"
          install_go_tool "github.com/projectdiscovery/httpx/cmd/httpx"
          install_go_tool "github.com/projectdiscovery/nuclei/v3/cmd/nuclei"
          install_go_tool "github.com/projectdiscovery/dnsx/cmd/dnsx"
          install_go_tool "github.com/projectdiscovery/katana/cmd/katana"
          install_go_tool "github.com/tomnomnom/assetfinder"
          install_go_tool "github.com/owasp-amass/amass/v4/...@latest" || echo "âš ï¸ Amass installation failed, continuing..."
          
          # Add Go bin to PATH
          echo "$HOME/go/bin" >> $GITHUB_PATH
          
          # Verify installations
          echo ""
          echo "ðŸ” Verifying tool installations:"
          command -v subfinder && echo "âœ… subfinder" || echo "âŒ subfinder"
          command -v httpx && echo "âœ… httpx" || echo "âŒ httpx"
          command -v nuclei && echo "âœ… nuclei" || echo "âŒ nuclei"
          command -v dnsx && echo "âœ… dnsx" || echo "âŒ dnsx"
          command -v katana && echo "âœ… katana" || echo "âŒ katana"

      - name: Update Nuclei Templates
        run: |
          nuclei -update-templates -silent
          echo "âœ… Nuclei templates updated"

      - name: Install Python Dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install --quiet --upgrade pip
            pip install --quiet -r requirements.txt
            echo "âœ… Python dependencies installed"
          fi

      - name: Restore Previous Scan State
        uses: actions/cache@v4
        with:
          path: |
            recon_results/*_state.json
            recon_results/*/cache
          key: recon-state-${{ matrix.domain }}-${{ github.run_number }}
          restore-keys: |
            recon-state-${{ matrix.domain }}-

      - name: Configure Scan Parameters
        id: config
        run: |
          # Determine scan flags based on mode
          SCAN_MODE="${{ github.event.inputs.scan_mode || 'passive' }}"
          
          case "$SCAN_MODE" in
            passive)
              FLAGS="--passive-only"
              echo "ðŸ” Passive scan mode (no active probing)"
              ;;
            standard)
              FLAGS="--passive-only --daily"
              echo "ðŸ” Standard scan mode (passive + validation)"
              ;;
            comprehensive)
              FLAGS="--daily"
              echo "ðŸ” Comprehensive scan mode (full assessment)"
              ;;
            *)
              FLAGS="--passive-only"
              echo "âš ï¸ Unknown mode, defaulting to passive"
              ;;
          esac
          
          echo "flags=$FLAGS" >> $GITHUB_OUTPUT

      - name: Run ReconMaster Scan
        id: scan
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          DOMAIN: ${{ matrix.domain }}
          SCAN_FLAGS: ${{ steps.config.outputs.flags }}
          SCAN_ID: ${{ needs.prepare.outputs.scan_id }}
        run: |
          set +e  # Don't exit on error
          
          echo "ðŸš€ Starting ReconMaster scan..."
          echo "Target: $DOMAIN"
          echo "Scan ID: $SCAN_ID"
          echo "Flags: $SCAN_FLAGS"
          echo ""
          
          # Create output directory
          mkdir -p recon_results
          
          # Run ReconMaster with timeout and error handling
          timeout ${{ env.SCAN_TIMEOUT }}m python3 reconmaster.py \
            -d "$DOMAIN" \
            $SCAN_FLAGS \
            --resume \
            ${WEBHOOK_URL:+--webhook "$WEBHOOK_URL"} \
            --i-understand-this-requires-authorization \
            --output-dir "recon_results" \
            2>&1 | tee scan.log
          
          EXIT_CODE=$?
          
          # Handle exit codes
          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Scan completed successfully"
          elif [ $EXIT_CODE -eq 124 ]; then
            echo "status=timeout" >> $GITHUB_OUTPUT
            echo "âš ï¸ Scan timed out after ${{ env.SCAN_TIMEOUT }} minutes"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Scan failed with exit code $EXIT_CODE"
          fi
          
          # Always save logs
          cp scan.log recon_results/scan_execution.log 2>/dev/null || true
          
          exit 0  # Don't fail the workflow

      - name: Validate Scan Results
        if: always()
        id: validate
        run: |
          echo "ðŸ” Validating scan results..."
          
          RESULTS_DIR=$(find recon_results -maxdepth 1 -type d -name "*${{ matrix.domain }}*" | head -n 1)
          
          if [ -z "$RESULTS_DIR" ]; then
            echo "âš ï¸ No results directory found"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ“ Results directory: $RESULTS_DIR"
          
          # Check for key result files
          FILES_FOUND=0
          if [ -f "$RESULTS_DIR/summary.json" ]; then
            FILES_FOUND=$((FILES_FOUND + 1))
            echo "âœ… summary.json found"
          fi
          
          if [ -f "$RESULTS_DIR/executive_report.md" ]; then
            FILES_FOUND=$((FILES_FOUND + 1))
            echo "âœ… executive_report.md found"
          fi
          
          if [ $FILES_FOUND -gt 0 ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "results_dir=$RESULTS_DIR" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No valid results found"
          fi

      - name: Generate GitHub Summary
        if: always()
        run: |
          echo "## ðŸ” ReconMaster Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Domain:** \`${{ matrix.domain }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Scan ID:** \`${{ needs.prepare.outputs.scan_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.scan.outputs.status || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ github.event.inputs.scan_mode || 'passive' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Include executive summary if available
          SUMMARY_FILE=$(find recon_results -name "executive_report.md" -type f | head -n 1)
          if [ -f "$SUMMARY_FILE" ]; then
            echo "### ðŸ“Š Executive Summary" >> $GITHUB_STEP_SUMMARY
            cat "$SUMMARY_FILE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No executive summary generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Security Findings Alert
        if: always() && steps.validate.outputs.valid == 'true'
        run: |
          echo "ðŸ”’ Checking for critical security findings..."
          
          RESULTS_DIR="${{ steps.validate.outputs.results_dir }}"
          
          # Check for subdomain takeovers
          TAKEOVER_FILE=$(find "$RESULTS_DIR" -name "takeovers.txt" -type f | head -n 1)
          if [ -f "$TAKEOVER_FILE" ] && [ -s "$TAKEOVER_FILE" ]; then
            echo "## âš ï¸ CRITICAL: Subdomain Takeover Detected!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 20 "$TAKEOVER_FILE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for critical vulnerabilities
          VULN_FILE=$(find "$RESULTS_DIR" -name "nuclei_results.json" -type f | head -n 1)
          if [ -f "$VULN_FILE" ]; then
            CRITICAL=$(jq -r 'select(.info.severity == "critical") | .info.name' "$VULN_FILE" 2>/dev/null | wc -l)
            HIGH=$(jq -r 'select(.info.severity == "high") | .info.name' "$VULN_FILE" 2>/dev/null | wc -l)
            
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "## ðŸš¨ Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- **Critical:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
              echo "- **High:** $HIGH" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Check for exposed secrets
          SECRETS_FILE=$(find "$RESULTS_DIR" -name "exposed_secrets.txt" -type f | head -n 1)
          if [ -f "$SECRETS_FILE" ] && [ -s "$SECRETS_FILE" ]; then
            SECRET_COUNT=$(wc -l < "$SECRETS_FILE")
            echo "## ðŸ”‘ Exposed Secrets Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Count:** $SECRET_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Review the artifacts for details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Scan Results
        uses: actions/upload-artifact@v4
        if: always() && steps.validate.outputs.valid == 'true'
        with:
          name: results-${{ matrix.domain }}-${{ needs.prepare.outputs.scan_id }}
          path: recon_results/
          retention-days: 30
          compression-level: 9
          if-no-files-found: warn

      - name: Upload Critical Findings
        uses: actions/upload-artifact@v4
        if: always() && steps.validate.outputs.valid == 'true'
        with:
          name: critical-${{ matrix.domain }}-${{ needs.prepare.outputs.scan_id }}
          path: |
            recon_results/**/executive_report.md
            recon_results/**/summary.json
            recon_results/**/full_report.html
            recon_results/**/vulns/nuclei_results.json
            recon_results/**/vulns/exposed_secrets.txt
            recon_results/**/takeovers.txt
            recon_results/scan_execution.log
          retention-days: 90
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        run: |
          # Clean up sensitive data from logs
          if [ -f scan.log ]; then
            sed -i 's/[A-Za-z0-9_-]\{32,\}/[REDACTED]/g' scan.log
          fi
          
          # Remove temporary files
          rm -rf /tmp/recon_* 2>/dev/null || true
          
          echo "âœ… Cleanup completed"

  # Aggregate results from all scans
  summary:
    name: Generate Summary Report
    needs: [prepare, recon]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: results-*

      - name: Create Combined Summary
        run: |
          cat > combined_summary.md << 'EOF'
          # ðŸ” ReconMaster Scan Summary
          
          ## Scan Information
          
          - **Scan ID:** `${{ needs.prepare.outputs.scan_id }}`
          - **Date:** `$(date -u +"%Y-%m-%d %H:%M:%S UTC")`
          - **Trigger:** `${{ github.event_name }}`
          - **Domains:** `${{ needs.prepare.outputs.domains }}`
          - **Run Number:** `${{ github.run_number }}`
          
          ## Results by Domain
          
          EOF
          
          # Aggregate findings from all scans
          for results_dir in all-results/results-*/; do
            if [ -d "$results_dir" ]; then
              DOMAIN=$(basename "$results_dir" | sed 's/results-//' | sed 's/-scan.*//')
              echo "---" >> combined_summary.md
              echo "" >> combined_summary.md
              echo "### $DOMAIN" >> combined_summary.md
              echo "" >> combined_summary.md
              
              # Include executive report if available
              EXEC_REPORT=$(find "$results_dir" -name "executive_report.md" -type f | head -n 1)
              if [ -f "$EXEC_REPORT" ]; then
                cat "$EXEC_REPORT" >> combined_summary.md
              else
                echo "âš ï¸ No report generated for this domain" >> combined_summary.md
              fi
              echo "" >> combined_summary.md
            fi
          done
          
          cat >> combined_summary.md << 'EOF'
          
          ---
          
          ## ðŸ“ Notes
          
          - Review individual domain artifacts for detailed findings
          - Critical findings are retained for 90 days
          - Full results are retained for 30 days
          
          ## âš ï¸ Next Steps
          
          1. Review critical and high-severity findings immediately
          2. Validate all findings before taking action
          3. Follow responsible disclosure practices
          4. Document all findings and remediation steps
          
          ---
          
          *Generated by ReconMaster v3.1.0*
          EOF

      - name: Upload Combined Summary
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ needs.prepare.outputs.scan_id }}
          path: combined_summary.md
          retention-days: 90

      - name: Notify on Completion
        if: github.event.inputs.notify == 'true' && secrets.WEBHOOK_URL != ''
        run: |
          curl -X POST "${{ secrets.WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "content": "ðŸ” ReconMaster Scan Completed",
              "embeds": [{
                "title": "Scan Summary",
                "description": "Scan ID: `${{ needs.prepare.outputs.scan_id }}`",
                "color": 3066993,
                "fields": [
                  {
                    "name": "Domains",
                    "value": "`${{ needs.prepare.outputs.domains }}`",
                    "inline": false
                  },
                  {
                    "name": "Status",
                    "value": "Completed",
                    "inline": true
                  },
                  {
                    "name": "Run",
                    "value": "#${{ github.run_number }}",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "ReconMaster v3.1.0"
                }
              }]
            }' || echo "âš ï¸ Notification failed"
